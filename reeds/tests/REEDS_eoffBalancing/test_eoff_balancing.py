import unittest
from reeds.function_libs.optimization import eds_eoff_rebalancing

import numpy as np


class test_Eoff_rebalancing(unittest.TestCase):
    #data:
    old_eoffs = np.array([[0., 19., -6.1, -51.59, -71.97],
                          [0., 19., -6.1, -51.59, -71.97],
                          [0., 19., -6.1, -51.59, -71.97],
                          [0., 19., -6.1, -51.59, -71.97],
                          [0., 19., -6.1, -51.59, -71.97],
                          [0., 19., -6.1, -51.59, -71.97],
                          [0., 19., -6.1, -51.59, -71.97],
                          [0., 19., -6.1, -51.59, -71.97],
                          [0., 19., -6.1, -51.59, -71.97],
                          [0., 19., -6.1, -51.59, -71.97],
                          [0., 19., -6.1, -51.59, -71.97],
                          [0., 19., -6.1, -51.59, -71.97],
                          [0., 19., -6.1, -51.59, -71.97],
                          [0., 19., -6.1, -51.59, -71.97],
                          [0., 19., -6.1, -51.59, -71.97],
                          [0., 19., -6.1, -51.59, -71.97],
                          [0., 19., -6.1, -51.59, -71.97],
                          [0., 19., -6.1, -51.59, -71.97],
                          [0., 19., -6.1, -51.59, -71.97],
                          [0., 19., -6.1, -51.59, -71.97],
                          [0., 19., -6.1, -51.59, -71.97],
                          [0., 19., -6.1, -51.59, -71.97],
                          [0., 19., -6.1, -51.59, -71.97],
                          [0., 19., -6.1, -51.59, -71.97],
                          [0., 19., -6.1, -51.59, -71.97],
                          [0., 19., -6.1, -51.59, -71.97],
                          [0., 19., -6.1, -51.59, -71.97],
                          [0., 19., -6.1, -51.59, -71.97],
                          [0., 19., -6.1, -51.59, -71.97],
                          [0., 19., -6.1, -51.59, -71.97],
                          [0., 19., -6.1, -51.59, -71.97],
                          [0., 19., -6.1, -51.59, -71.97],
                          [0., 19., -6.1, -51.59, -71.97],
                          [0., 19., -6.1, -51.59, -71.97],
                          [0., 19., -6.1, -51.59, -71.97],
                          [0., 19., -6.1, -51.59, -71.97],
                          [0., 19., -6.1, -51.59, -71.97],
                          [0., 19., -6.1, -51.59, -71.97],
                          [0., 19., -6.1, -51.59, -71.97],
                          [0., 19., -6.1, -51.59, -71.97],
                          [0., 19., -6.1, -51.59, -71.97]])
    sampling_stat = {1: {'minV_state': {1: 0.039626666666666664,
                                              2: 0.9223466666666666,
                                              3: 0,
                                              4: 0.03802666666666667,
                                              5: 0}, 'max_contributing_state': {1: 0.039626666666666664,
                                                              2: 0.9223466666666666,
                                                              3: 0,
                                                              4: 0.03802666666666667,
                                                              5: 0},
                         'occurence_state': {1: 0.03965333333333333,
                                             2: 0.9223466666666666,
                                             3: 0.0,
                                             4: 0.038213333333333335,
                                             5: 0.0}},
                     2: {'minV_state': {1: 0.039626666666666664,
                                              2: 0.9223466666666666,
                                              3: 0,
                                              4: 0.03802666666666667,
                                              5: 0},
                         'max_contributing_state': {1: 0.039626666666666664,
                                  2: 0.9223466666666666,
                                  3: 0,
                                  4: 0.03802666666666667,
                                  5: 0},
                         'occurence_state': {1: 0.03970666666666667,
                                             2: 0.9223466666666666,
                                             3: 0.0,
                                             4: 0.03816,
                                             5: 0.0}},
                     3: {'minV_state': {1: 0.039626666666666664,
                                              2: 0.9223466666666666,
                                              3: 0,
                                              4: 0.03802666666666667,
                                              5: 0},
                         'max_contributing_state': {1: 0.039626666666666664,
                                  2: 0.9223466666666666,
                                  3: 0,
                                  4: 0.03802666666666667,
                                  5: 0},
                         'occurence_state': {1: 0.039733333333333336,
                                             2: 0.9223466666666666,
                                             3: 0.0,
                                             4: 0.03824,
                                             5: 0.0}},
                     4: {'minV_state': {1: 0.039626666666666664,
                                              2: 0.9223466666666666,
                                              3: 0,
                                              4: 0.03802666666666667,
                                              5: 0},
                         'max_contributing_state': {1: 0.039626666666666664,
                                  2: 0.9223466666666666,
                                  3: 0,
                                  4: 0.03802666666666667,
                                  5: 0},
                         'occurence_state': {1: 0.03981333333333333,
                                             2: 0.9223466666666666,
                                             3: 0.0,
                                             4: 0.03816,
                                             5: 0.0}},
                     5: {'minV_state': {1: 0.039626666666666664,
                                              2: 0.9223466666666666,
                                              3: 0,
                                              4: 0.03802666666666667,
                                              5: 0},
                         'max_contributing_state': {1: 0.039626666666666664,
                                  2: 0.9223466666666666,
                                  3: 0,
                                  4: 0.03802666666666667,
                                  5: 0},
                         'occurence_state': {1: 0.03970666666666667,
                                             2: 0.9223733333333334,
                                             3: 0.0,
                                             4: 0.038213333333333335,
                                             5: 0.0}},
                     6: {'minV_state': {1: 0.039626666666666664,
                                              2: 0.9223466666666666,
                                              3: 0,
                                              4: 0.03802666666666667,
                                              5: 0},
                         'max_contributing_state': {1: 0.039626666666666664,
                                  2: 0.9223466666666666,
                                  3: 0,
                                  4: 0.03802666666666667,
                                  5: 0},
                         'occurence_state': {1: 0.03968,
                                             2: 0.9223733333333334,
                                             3: 0.0,
                                             4: 0.038213333333333335,
                                             5: 0.0}},
                     7: {'minV_state': {1: 0.039626666666666664,
                                              2: 0.9223466666666666,
                                              3: 0,
                                              4: 0.03802666666666667,
                                              5: 0},
                         'max_contributing_state': {1: 0.039626666666666664,
                                  2: 0.9223466666666666,
                                  3: 0,
                                  4: 0.03802666666666667,
                                  5: 0},
                         'occurence_state': {1: 0.03965333333333333,
                                             2: 0.9223466666666666,
                                             3: 0.0,
                                             4: 0.03813333333333333,
                                             5: 0.0}},
                     8: {'minV_state': {1: 0.039626666666666664,
                                              2: 0.9223466666666666,
                                              3: 0,
                                              4: 0.03802666666666667,
                                              5: 0},
                         'max_contributing_state': {1: 0.039626666666666664,
                                  2: 0.9223466666666666,
                                  3: 0,
                                  4: 0.03802666666666667,
                                  5: 0},
                         'occurence_state': {1: 0.03970666666666667,
                                             2: 0.9223466666666666,
                                             3: 0.0,
                                             4: 0.038213333333333335,
                                             5: 0.0}},
                     9: {'minV_state': {1: 0.039626666666666664,
                                              2: 0.9223466666666666,
                                              3: 0,
                                              4: 0.03802666666666667,
                                              5: 0},
                         'max_contributing_state': {1: 0.039626666666666664,
                                  2: 0.9223466666666666,
                                  3: 0,
                                  4: 0.03802666666666667,
                                  5: 0},
                         'occurence_state': {1: 0.039626666666666664,
                                             2: 0.9223466666666666,
                                             3: 0.0,
                                             4: 0.03816,
                                             5: 0.0}},
                     10: {'minV_state': {1: 0.039626666666666664,
                                               2: 0.9223466666666666,
                                               3: 0,
                                               4: 0.03802666666666667,
                                               5: 0},
                          'max_contributing_state': {1: 0.039626666666666664,
                                   2: 0.9223466666666666,
                                   3: 0,
                                   4: 0.03802666666666667,
                                   5: 0},
                          'occurence_state': {1: 0.03968,
                                              2: 0.9223466666666666,
                                              3: 0.0,
                                              4: 0.03818666666666667,
                                              5: 0.0}},
                     11: {'minV_state': {1: 0.039626666666666664,
                                               2: 0.9223466666666666,
                                               3: 0,
                                               4: 0.03802666666666667,
                                               5: 0},
                          'max_contributing_state': {1: 0.039626666666666664,
                                   2: 0.9223466666666666,
                                   3: 0,
                                   4: 0.03802666666666667,
                                   5: 0},
                          'occurence_state': {1: 0.03970666666666667,
                                              2: 0.9223466666666666,
                                              3: 0.0,
                                              4: 0.038053333333333335,
                                              5: 0.0}},
                     12: {'minV_state': {1: 0.039626666666666664,
                                               2: 0.9223466666666666,
                                               3: 0,
                                               4: 0.03802666666666667,
                                               5: 0},
                          'max_contributing_state': {1: 0.039626666666666664,
                                   2: 0.9223466666666666,
                                   3: 0,
                                   4: 0.03802666666666667,
                                   5: 0},
                          'occurence_state': {1: 0.03965333333333333,
                                              2: 0.9223466666666666,
                                              3: 0.0,
                                              4: 0.03818666666666667,
                                              5: 0.0}},
                     13: {'minV_state': {1: 0.03965333333333333,
                                               2: 0.92232,
                                               3: 0,
                                               4: 0.03802666666666667,
                                               5: 0},
                          'max_contributing_state': {1: 0.03965333333333333,
                                   2: 0.92232,
                                   3: 0,
                                   4: 0.03802666666666667,
                                   5: 0},
                          'occurence_state': {1: 0.03976,
                                              2: 0.92232,
                                              3: 0.0,
                                              4: 0.038213333333333335,
                                              5: 0.0}},
                     14: {'minV_state': {1: 0.03965333333333333,
                                               2: 0.92232,
                                               3: 0,
                                               4: 0.03802666666666667,
                                               5: 0},
                          'max_contributing_state': {1: 0.03965333333333333,
                                   2: 0.92232,
                                   3: 0,
                                   4: 0.03802666666666667,
                                   5: 0},
                          'occurence_state': {1: 0.03976,
                                              2: 0.92232,
                                              3: 0.0,
                                              4: 0.03813333333333333,
                                              5: 2.6666666666666667e-05}},
                     15: {'minV_state': {1: 0.03965333333333333,
                                               2: 0.92232,
                                               3: 0,
                                               4: 0.03802666666666667,
                                               5: 0},
                          'max_contributing_state': {1: 0.03965333333333333,
                                   2: 0.92232,
                                   3: 0,
                                   4: 0.03802666666666667,
                                   5: 0},
                          'occurence_state': {1: 0.039733333333333336,
                                              2: 0.92232,
                                              3: 0.0,
                                              4: 0.03818666666666667,
                                              5: 5.333333333333333e-05}},
                     16: {'minV_state': {1: 0.03965333333333333,
                                               2: 0.92232,
                                               3: 0,
                                               4: 0.03802666666666667,
                                               5: 0},
                          'max_contributing_state': {1: 0.03965333333333333,
                                   2: 0.92232,
                                   3: 0,
                                   4: 0.03802666666666667,
                                   5: 0},
                          'occurence_state': {1: 0.03976,
                                              2: 0.92232,
                                              3: 0.0,
                                              4: 0.03829333333333333,
                                              5: 2.6666666666666667e-05}},
                     17: {'minV_state': {1: 0.03965333333333333,
                                               2: 0.92232,
                                               3: 0,
                                               4: 0.03802666666666667,
                                               5: 0},
                          'max_contributing_state': {1: 0.03965333333333333,
                                   2: 0.92232,
                                   3: 0,
                                   4: 0.03802666666666667,
                                   5: 0},
                          'occurence_state': {1: 0.039786666666666665,
                                              2: 0.92232,
                                              3: 0.0,
                                              4: 0.03813333333333333,
                                              5: 0.0}},
                     18: {'minV_state': {1: 0.03965333333333333,
                                               2: 0.92232,
                                               3: 0,
                                               4: 0.03802666666666667,
                                               5: 0},
                          'max_contributing_state': {1: 0.03965333333333333,
                                   2: 0.92232,
                                   3: 0,
                                   4: 0.03802666666666667,
                                   5: 0},
                          'occurence_state': {1: 0.03970666666666667,
                                              2: 0.92232,
                                              3: 0.0,
                                              4: 0.03816,
                                              5: 0.0}},
                     19: {'minV_state': {1: 0.03970666666666667,
                                               2: 0.9222666666666667,
                                               3: 0,
                                               4: 0.03802666666666667,
                                               5: 0},
                          'max_contributing_state': {1: 0.03970666666666667,
                                   2: 0.9222666666666667,
                                   3: 0,
                                   4: 0.03802666666666667,
                                   5: 0},
                          'occurence_state': {1: 0.039786666666666665,
                                              2: 0.9222666666666667,
                                              3: 0.0,
                                              4: 0.03813333333333333,
                                              5: 2.6666666666666667e-05}},
                     20: {'minV_state': {1: 0.039786666666666665,
                                               2: 0.9221066666666666,
                                               3: 0,
                                               4: 0.038106666666666664,
                                               5: 0},
                          'max_contributing_state': {1: 0.03981333333333333,
                                   2: 0.92216,
                                   3: 0,
                                   4: 0.03802666666666667,
                                   5: 0},
                          'occurence_state': {1: 0.04034666666666667,
                                              2: 0.92216,
                                              3: 0.0,
                                              4: 0.03832,
                                              5: 0.0}},
                     21: {'minV_state': {1: 0.05210666666666667,
                                               2: 0.9048,
                                               3: 0,
                                               4: 0.042453333333333336,
                                               5: 0.00064},
                          'max_contributing_state': {1: 0.047786666666666665,
                                   2: 0.9130933333333333,
                                   3: 0,
                                   4: 0.038533333333333336,
                                   5: 0.0005866666666666667},
                          'occurence_state': {1: 0.07306666666666667,
                                              2: 0.92088,
                                              3: 0.0,
                                              4: 0.04477333333333333,
                                              5: 0.00064}},
                     22: {'minV_state': {1: 0.07429333333333334,
                                               2: 0.8751466666666666,
                                               3: 0,
                                               4: 0.049146666666666665,
                                               5: 0.0014133333333333333},
                          'max_contributing_state': {1: 0.06168,
                                   2: 0.89816,
                                   3: 0,
                                   4: 0.03917333333333333,
                                   5: 0.0009866666666666667},
                          'occurence_state': {1: 0.12797333333333333,
                                              2: 0.9201066666666666,
                                              3: 0.0,
                                              4: 0.05416,
                                              5: 0.00152}},
                     23: {'minV_state': {1: 0.13234666666666667,
                                               2: 0.7981333333333334,
                                               3: 0,
                                               4: 0.06610666666666666,
                                               5: 0.0034133333333333333},
                          'max_contributing_state': {1: 0.09509333333333334,
                                   2: 0.86136,
                                   3: 0,
                                   4: 0.041253333333333336,
                                   5: 0.0022933333333333334},
                          'occurence_state': {1: 0.26336,
                                              2: 0.92056,
                                              3: 5.333333333333333e-05,
                                              4: 0.07882666666666667,
                                              5: 0.00408}},
                     24: {'minV_state': {1: 0.26397333333333334,
                                               2: 0.59256,
                                               3: 0,
                                               4: 0.13106666666666666,
                                               5: 0.0124},
                          'max_contributing_state': {1: 0.18458666666666668,
                                   2: 0.7593866666666667,
                                   3: 0,
                                   4: 0.04890666666666667,
                                   5: 0.00712},
                          'occurence_state': {1: 0.5732266666666667,
                                              2: 0.9201066666666666,
                                              3: 0.0,
                                              4: 0.17221333333333333,
                                              5: 0.015226666666666666}},
                     25: {'minV_state': {1: 0.3406133333333333,
                                               2: 0.38144,
                                               3: 2.6666666666666667e-05,
                                               4: 0.25136,
                                               5: 0.02656},
                          'max_contributing_state': {1: 0.26528,
                                   2: 0.6541066666666666,
                                   3: 0,
                                   4: 0.06658666666666667,
                                   5: 0.014026666666666666},
                          'occurence_state': {1: 0.8408533333333333,
                                              2: 0.9153333333333333,
                                              3: 0.00021333333333333333,
                                              4: 0.3388,
                                              5: 0.035973333333333336}},
                     26: {'minV_state': {1: 0.30288,
                                               2: 0.23794666666666667,
                                               3: 0.00010666666666666667,
                                               4: 0.40008,
                                               5: 0.058986666666666666},
                          'max_contributing_state': {1: 0.30277333333333334,
                                   2: 0.58112,
                                   3: 8e-05,
                                   4: 0.09058666666666666,
                                   5: 0.02544},
                          'occurence_state': {1: 0.93952,
                                              2: 0.9251466666666667,
                                              3: 0.00088,
                                              4: 0.5560533333333333,
                                              5: 0.08546666666666666}},
                     27: {'minV_state': {1: 0.11930666666666667,
                                               2: 0.06525333333333333,
                                               3: 0.0007733333333333333,
                                               4: 0.5852266666666667,
                                               5: 0.22944},
                          'max_contributing_state': {1: 0.30952,
                                   2: 0.46224,
                                   3: 0.0013066666666666667,
                                   4: 0.14349333333333333,
                                   5: 0.08344},
                          'occurence_state': {1: 0.95336,
                                              2: 0.9291466666666667,
                                              3: 0.006,
                                              4: 0.9093866666666667,
                                              5: 0.3450933333333333}},
                     28: {'minV_state': {1: 0.06304,
                                               2: 0.027146666666666666,
                                               3: 0.00104,
                                               4: 0.5171466666666666,
                                               5: 0.3916266666666667},
                          'max_contributing_state': {1: 0.29949333333333333,
                                   2: 0.40818666666666664,
                                   3: 0.0033333333333333335,
                                   4: 0.15805333333333332,
                                   5: 0.13093333333333335},
                          'occurence_state': {1: 0.9474666666666667,
                                              2: 0.9267466666666667,
                                              3: 0.0148,
                                              4: 0.9595733333333333,
                                              5: 0.5927733333333334}},
                     29: {'minV_state': {1: 0.03368,
                                               2: 0.012426666666666667,
                                               3: 0.00208,
                                               4: 0.41018666666666664,
                                               5: 0.5416266666666667},
                          'max_contributing_state': {1: 0.2869333333333333,
                                   2: 0.36349333333333333,
                                   3: 0.007306666666666667,
                                   4: 0.16562666666666667,
                                   5: 0.17664},
                          'occurence_state': {1: 0.93312,
                                              2: 0.9258933333333333,
                                              3: 0.0332,
                                              4: 0.9737333333333333,
                                              5: 0.8122666666666667}},
                     30: {'minV_state': {1: 0.02416,
                                               2: 0.00792,
                                               3: 0.0034133333333333333,
                                               4: 0.3724266666666667,
                                               5: 0.59208},
                          'max_contributing_state': {1: 0.2832266666666667,
                                   2: 0.3472266666666667,
                                   3: 0.0132,
                                   4: 0.16821333333333333,
                                   5: 0.18813333333333335},
                          'occurence_state': {1: 0.9276266666666667,
                                              2: 0.9202133333333333,
                                              3: 0.056986666666666665,
                                              4: 0.9749066666666667,
                                              5: 0.8854133333333334}},
                     31: {'minV_state': {1: 0.023013333333333334,
                                               2: 0.0064266666666666665,
                                               3: 0.004026666666666666,
                                               4: 0.35568,
                                               5: 0.6108533333333334},
                          'max_contributing_state': {1: 0.27784, 2: 0.3444, 3: 0.0184, 4: 0.16728, 5: 0.19208},
                          'occurence_state': {1: 0.9229866666666666,
                                              2: 0.9174933333333334,
                                              3: 0.07834666666666666,
                                              4: 0.9746933333333333,
                                              5: 0.9098933333333333}},
                     32: {'minV_state': {1: 0.020346666666666666,
                                               2: 0.005386666666666666,
                                               3: 0.0058133333333333335,
                                               4: 0.34352,
                                               5: 0.6249333333333333},
                          'max_contributing_state': {1: 0.27957333333333334,
                                   2: 0.33448,
                                   3: 0.022933333333333333,
                                   4: 0.16928,
                                   5: 0.19373333333333334},
                          'occurence_state': {1: 0.9164,
                                              2: 0.9098933333333333,
                                              3: 0.10514666666666667,
                                              4: 0.97392,
                                              5: 0.92904}},
                     33: {'minV_state': {1: 0.019573333333333335,
                                               2: 0.004906666666666667,
                                               3: 0.007226666666666667,
                                               4: 0.3378933333333333,
                                               5: 0.6304},
                          'max_contributing_state': {1: 0.27344,
                                   2: 0.32957333333333333,
                                   3: 0.03288,
                                   4: 0.16754666666666668,
                                   5: 0.19656},
                          'occurence_state': {1: 0.90448,
                                              2: 0.9027466666666667,
                                              3: 0.146,
                                              4: 0.9722133333333334,
                                              5: 0.94016}},
                     34: {'minV_state': {1: 0.018533333333333332,
                                               2: 0.00464,
                                               3: 0.008693333333333334,
                                               4: 0.33026666666666665,
                                               5: 0.6378666666666667},
                          'max_contributing_state': {1: 0.2727733333333333,
                                   2: 0.32272,
                                   3: 0.042666666666666665,
                                   4: 0.16634666666666667,
                                   5: 0.19549333333333332},
                          'occurence_state': {1: 0.8903733333333333,
                                              2: 0.8893333333333333,
                                              3: 0.19293333333333335,
                                              4: 0.97,
                                              5: 0.9484}},
                     35: {'minV_state': {1: 0.01664,
                                               2: 0.004186666666666667,
                                               3: 0.010933333333333333,
                                               4: 0.34008,
                                               5: 0.62816},
                          'max_contributing_state': {1: 0.26552,
                                   2: 0.30994666666666665,
                                   3: 0.05768,
                                   4: 0.17144,
                                   5: 0.19541333333333333},
                          'occurence_state': {1: 0.87416,
                                              2: 0.86856,
                                              3: 0.25970666666666664,
                                              4: 0.9656,
                                              5: 0.9501866666666666}},
                     36: {'minV_state': {1: 0.016053333333333333,
                                               2: 0.00392,
                                               3: 0.01296,
                                               4: 0.34717333333333333,
                                               5: 0.6198933333333333},
                          'max_contributing_state': {1: 0.26248,
                                   2: 0.29984,
                                   3: 0.07613333333333333,
                                   4: 0.17562666666666665,
                                   5: 0.18592},
                          'occurence_state': {1: 0.85048,
                                              2: 0.8487733333333334,
                                              3: 0.33776,
                                              4: 0.9611733333333333,
                                              5: 0.95072}},
                     37: {'minV_state': {1: 0.01704,
                                               2: 0.004026666666666666,
                                               3: 0.014293333333333333,
                                               4: 0.34928,
                                               5: 0.61536},
                          'max_contributing_state': {1: 0.26298666666666665,
                                   2: 0.29213333333333336,
                                   3: 0.0892,
                                   4: 0.17552,
                                   5: 0.18016},
                          'occurence_state': {1: 0.83128,
                                              2: 0.8274133333333333,
                                              3: 0.4043733333333333,
                                              4: 0.9552,
                                              5: 0.9506133333333333}},
                     38: {'minV_state': {1: 0.01728,
                                               2: 0.004293333333333333,
                                               3: 0.016533333333333334,
                                               4: 0.34786666666666666,
                                               5: 0.6140266666666667},
                          'max_contributing_state': {1: 0.2572,
                                   2: 0.28613333333333335,
                                   3: 0.10744,
                                   4: 0.16978666666666667,
                                   5: 0.17944},
                          'occurence_state': {1: 0.8118933333333334,
                                              2: 0.81248,
                                              3: 0.47728,
                                              4: 0.9513066666666666,
                                              5: 0.9520533333333333}},
                     39: {'minV_state': {1: 0.014933333333333333,
                                               2: 0.00272,
                                               3: 0.016026666666666668,
                                               4: 0.34176,
                                               5: 0.62456},
                          'max_contributing_state': {1: 0.24597333333333332,
                                   2: 0.26912,
                                   3: 0.136,
                                   4: 0.1776,
                                   5: 0.17130666666666666},
                          'occurence_state': {1: 0.78296,
                                              2: 0.7806666666666666,
                                              3: 0.6314666666666666,
                                              4: 0.9482666666666667,
                                              5: 0.9636}},
                     40: {'minV_state': {1: 0.010533333333333334,
                                               2: 0.0022933333333333334,
                                               3: 0.014693333333333333,
                                               4: 0.33216,
                                               5: 0.64032},
                          'max_contributing_state': {1: 0.24394666666666667,
                                   2: 0.26714666666666664,
                                   3: 0.14032,
                                   4: 0.18005333333333334,
                                   5: 0.16853333333333334},
                          'occurence_state': {1: 0.78712,
                                              2: 0.7858133333333334,
                                              3: 0.6550666666666667,
                                              4: 0.9518133333333333,
                                              5: 0.97456}},
                     41: {'minV_state': {1: 0.009546666666666667,
                                               2: 0.0019733333333333334,
                                               3: 0.012506666666666666,
                                               4: 0.32578666666666667,
                                               5: 0.6501866666666667},
                          'max_contributing_state': {1: 0.24504,
                                   2: 0.26424,
                                   3: 0.14397333333333334,
                                   4: 0.17749333333333334,
                                   5: 0.16925333333333334},
                          'occurence_state': {1: 0.79232,
                                              2: 0.7926933333333334,
                                              3: 0.6739733333333333,
                                              4: 0.95808,
                                              5: 0.9798133333333333}}}

    def test_eoff_correctionF_oneSided(self):
        # params:
        samplingDists = np.array(np.linspace(0.0, 1, 100), ndmin=2)
        expected_res = np.array([[ 5.70513779,  5.70513779,  5.68023597,  4.67561108,  3.96281837,  3.40993339,
                                    2.95819347,2.57625281,2.24540076,1.95356858,1.69251579,1.45636482,
                                    1.24077587,1.04245326,0.85883521,0.68789089,0.52798316,0.37777294,
                                    0.23615097,0.10218809,-0.02490182,-0.14578969,-0.26105279,-0.37119136,
                                    -0.47664174,-0.57778679,-0.67496434,-0.76847392,-0.85858239,-0.9455285,
                                    -1.02952671,-1.11077038,-1.18943444,-1.26567768,-1.33964467,-1.41146737,
                                    -1.48126663,-1.54915334,-1.61522952,-1.67958924,-1.74231942,-1.80350055,
                                    -1.86320729,-1.92150904,-1.97847039,-2.03415161,-2.08860896,-2.1418951,
                                    -2.19405934,-2.24514795,-2.2952044,-2.34426956,-2.39238195,-2.43957785,
                                    -2.48589153,-2.53135537,-2.576,-2.61985442,-2.66294611,-2.70530115,
                                    -2.74694432,-2.78789913,-2.82818798,-2.86783219,-2.90685205,-2.94526692,
                                    -2.98309529,-3.02035479,-3.05706227,-3.09323386,-3.12888498,-3.16403039,
                                    -3.19868424,-3.23286009,-3.26657094,-3.29982929,-3.33264712,-3.36503595,
                                    -3.39700684,-3.42857045,-3.45973702,-3.49051642,-3.52091815,-3.55095137,
                                    -3.58062489,-3.60994725,-3.63892664,-3.667571,-3.695888,-3.72388502,
                                    -3.75156921,-3.7789475,-3.80602657,-3.83281288,-3.8593127,-3.8855321,
                                    -3.91147694,-3.93715292,-3.96256555,-3.98772018]])

        ddEoff = eds_eoff_rebalancing.calculate_Eoff_Correction(samplingDists=samplingDists, _shift_eoff_zero=False, _nstates=5,
                                                                verbose=True)

        np.testing.assert_almost_equal(actual=ddEoff, desired=expected_res, decimal=5)

    def test_eoff_correctionF_twoSided(self):
        # params:
        samplingDists = np.array(np.linspace(0.0, 1, 100), ndmin=2)
        expected_res = np.array([[ 5.70513779e+00,  5.70513779e+00,  5.68023597e+00,  4.67561108e+00,
        3.96281837e+00,  3.40993339e+00,  2.95819347e+00,  2.57625281e+00,
        2.24540076e+00,  1.95356858e+00,  1.69251579e+00,  1.45636482e+00,
        1.24077587e+00,  1.04245326e+00,  8.58835209e-01,  6.87890891e-01,
        5.27983161e-01,  3.77772938e-01,  2.36150972e-01,  1.02188085e-01,
       -8.35653359e-03, -5.05672625e-02, -9.35095828e-02, -1.37209302e-01,
       -1.81693618e-01, -2.26991221e-01, -2.73132403e-01, -3.20149181e-01,
       -3.68075431e-01, -4.16947032e-01, -4.66802031e-01, -5.17680818e-01,
       -5.69626324e-01, -6.22684237e-01, -6.76903246e-01, -7.32335309e-01,
       -7.89035950e-01, -8.47064594e-01, -9.06484944e-01, -9.67365399e-01,
       -1.02977953e+00, -1.09380660e+00, -1.15953220e+00, -1.22704891e+00,
       -1.29645709e+00, -1.36786577e+00, -1.44139371e+00, -1.51717056e+00,
       -1.59533824e+00, -1.67605254e+00, -1.75948500e+00, -1.84582509e+00,
       -1.93528281e+00, -2.02809178e+00, -2.12451289e+00, -2.22483874e+00,
       -2.32939897e+00, -2.43856684e+00, -2.55276724e+00, -2.67248665e+00,
       -2.79828574e+00, -2.93081518e+00, -3.07083604e+00, -3.21924626e+00,
       -3.37711556e+00, -3.54573230e+00, -3.72666740e+00, -3.92186355e+00,
       -4.13376269e+00, -4.36549312e+00, -4.62115372e+00, -4.90626214e+00,
       -5.22849605e+00, -5.59899231e+00, -6.03479834e+00, -6.56397300e+00,
       -7.23774585e+00, -8.16612750e+00, -8.42718029e+00, -8.42718029e+00,
       -8.42718029e+00, -8.42718029e+00, -8.42718029e+00, -8.42718029e+00,
       -8.42718029e+00, -8.42718029e+00, -8.42718029e+00, -8.42718029e+00,
       -8.42718029e+00, -8.42718029e+00, -8.42718029e+00, -8.42718029e+00,
       -8.42718029e+00, -8.42718029e+00, -8.42718029e+00, -8.42718029e+00,
       -8.42718029e+00, -8.42718029e+00, -8.42718029e+00, -8.42718029e+00]])

        ddEoff = eds_eoff_rebalancing.calculate_Eoff_Correction(samplingDists=samplingDists, double_sided=True,
                                                                double_sided_widthFactor=0.8,  _nstates=5,
                                                                _shift_eoff_zero=False, verbose=True)

        np.testing.assert_almost_equal(actual=ddEoff, desired=expected_res, decimal=5)

    def test_eoff_correctionF_oneSided_learningFactor(self):
        # params:
        samplingDists = np.array(np.round(np.linspace(0.0, 1, 10), 1), ndmin=2)
        expected_res = np.array([[5.70513779, -0., -1.7174176, -2.7220425, -3.43483521, -4.4394601,
                                  -4.82140076, -5.15225281, -5.444085, -5.70513779]])
        learningFactors = [1 / (2 ** x) for x in range(3)]

        for lf in learningFactors:
            ddEoff = eds_eoff_rebalancing.calculate_Eoff_Correction(samplingDists=samplingDists, learningFactor=lf,
                                                                    _shift_eoff_zero=False, verbose=True)
            np.testing.assert_almost_equal(actual=ddEoff, desired=expected_res * lf, decimal=5)


    def test_eoff_rebalancing_directCounting_s1Only(self):

        expected_eoffs =np.array([[0.0, 11.201609269389472, -4.405816282465172, -51.48788211898036, -70.27581628246517],
                                  [0.0, 11.201609269389472, -4.405816282465172, -51.48788211898036, -70.27581628246517],
                                  [0.0, 11.201609269389472, -4.405816282465172, -51.48788211898036, -70.27581628246517],
                                  [0.0, 11.201609269389472, -4.405816282465172, -51.48788211898036, -70.27581628246517],
                                  [0.0, 11.201609269389472, -4.405816282465172, -51.48788211898036, -70.27581628246517],
                                  [0.0, 11.201609269389472, -4.405816282465172, -51.48788211898036, -70.27581628246517],
                                  [0.0, 11.201609269389472, -4.405816282465172, -51.48788211898036, -70.27581628246517],
                                  [0.0, 11.201609269389472, -4.405816282465172, -51.48788211898036, -70.27581628246517],
                                  [0.0, 11.201609269389472, -4.405816282465172, -51.48788211898036, -70.27581628246517],
                                  [0.0, 11.201609269389472, -4.405816282465172, -51.48788211898036, -70.27581628246517],
                                  [0.0, 11.201609269389472, -4.405816282465172, -51.48788211898036, -70.27581628246517],
                                  [0.0, 11.201609269389472, -4.405816282465172, -51.48788211898036, -70.27581628246517],
                                  [0.0, 11.201609269389472, -4.405816282465172, -51.48788211898036, -70.27581628246517],
                                  [0.0, 11.201609269389472, -4.405816282465172, -51.48788211898036, -70.27581628246517],
                                  [0.0, 11.201609269389472, -4.405816282465172, -51.48788211898036, -70.27581628246517],
                                  [0.0, 11.201609269389472, -4.405816282465172, -51.48788211898036, -70.27581628246517],
                                  [0.0, 11.201609269389472, -4.405816282465172, -51.48788211898036, -70.27581628246517],
                                  [0.0, 11.201609269389472, -4.405816282465172, -51.48788211898036, -70.27581628246517],
                                  [0.0, 11.201609269389472, -4.405816282465172, -51.48788211898036, -70.27581628246517],
                                  [0.0, 11.201609269389472, -4.405816282465172, -51.48788211898036, -70.27581628246517],
                                  [0.0, 11.201609269389472, -4.405816282465172, -51.48788211898036, -70.27581628246517],
                                  [0.0, 11.201609269389472, -4.405816282465172, -51.48788211898036, -70.27581628246517],
                                  [0.0, 11.201609269389472, -4.405816282465172, -51.48788211898036, -70.27581628246517],
                                  [0.0, 11.201609269389472, -4.405816282465172, -51.48788211898036, -70.27581628246517],
                                  [0.0, 11.201609269389472, -4.405816282465172, -51.48788211898036, -70.27581628246517],
                                  [0.0, 11.201609269389472, -4.405816282465172, -51.48788211898036, -70.27581628246517],
                                  [0.0, 11.201609269389472, -4.405816282465172, -51.48788211898036, -70.27581628246517],
                                  [0.0, 11.201609269389472, -4.405816282465172, -51.48788211898036, -70.27581628246517],
                                  [0.0, 11.201609269389472, -4.405816282465172, -51.48788211898036, -70.27581628246517],
                                  [0.0, 11.201609269389472, -4.405816282465172, -51.48788211898036, -70.27581628246517],
                                  [0.0, 11.201609269389472, -4.405816282465172, -51.48788211898036, -70.27581628246517],
                                  [0.0, 11.201609269389472, -4.405816282465172, -51.48788211898036, -70.27581628246517],
                                  [0.0, 11.201609269389472, -4.405816282465172, -51.48788211898036, -70.27581628246517],
                                  [0.0, 11.201609269389472, -4.405816282465172, -51.48788211898036, -70.27581628246517],
                                  [0.0, 11.201609269389472, -4.405816282465172, -51.48788211898036, -70.27581628246517],
                                  [0.0, 11.201609269389472, -4.405816282465172, -51.48788211898036, -70.27581628246517],
                                  [0.0, 11.201609269389472, -4.405816282465172, -51.48788211898036, -70.27581628246517],
                                  [0.0, 11.201609269389472, -4.405816282465172, -51.48788211898036, -70.27581628246517],
                                  [0.0, 11.201609269389472, -4.405816282465172, -51.48788211898036, -70.27581628246517],
                                  [0.0, 11.201609269389472, -4.405816282465172, -51.48788211898036, -70.27581628246517],
                                  [0.0, 11.201609269389472, -4.405816282465172, -51.48788211898036, -70.27581628246517]])
        old_eoffs = self.old_eoffs
        sampling_stat = self.sampling_stat

        new_eoffs = eds_eoff_rebalancing.rebalance_eoffs_directCounting(old_eoffs=old_eoffs,
                                                            sampling_stat=sampling_stat,
                                                            correct_for_s1_only=True)
        np.testing.assert_almost_equal(actual=new_eoffs, desired=expected_eoffs, decimal=5)

    def test_eoff_rebalancing_directCounting_allS(self):
        expected_eoffs = np.array([[0.0, 11.201609269389472, -4.405816282465172, -51.48788211898036, -70.27581628246517],
                                   [0.0, 11.201609269389472, -4.405816282465172, -51.48788211898036, -70.27581628246517],
                                   [0.0, 11.201609269389472, -4.405816282465172, -51.48788211898036, -70.27581628246517],
                                   [0.0, 11.201609269389472, -4.405816282465172, -51.48788211898036, -70.27581628246517],
                                   [0.0, 11.201609269389472, -4.405816282465172, -51.48788211898036, -70.27581628246517],
                                   [0.0, 11.201609269389472, -4.405816282465172, -51.48788211898036, -70.27581628246517],
                                   [0.0, 11.201609269389472, -4.405816282465172, -51.48788211898036, -70.27581628246517],
                                   [0.0, 11.201609269389472, -4.405816282465172, -51.48788211898036, -70.27581628246517],
                                   [0.0, 11.201609269389472, -4.405816282465172, -51.48788211898036, -70.27581628246517],
                                   [0.0, 11.201609269389472, -4.405816282465172, -51.48788211898036, -70.27581628246517],
                                   [0.0, 11.201609269389472, -4.405816282465172, -51.48788211898036, -70.27581628246517],
                                   [0.0, 11.201609269389472, -4.405816282465172, -51.48788211898036, -70.27581628246517],
                                   [0.0, 11.203347713287997, -4.404149474558272, -51.48621531107346, -70.27414947455827],
                                   [0.0, 11.203347713287997, -4.404149474558272, -51.48621531107346, -70.27414947455827],
                                   [0.0, 11.203347713287997, -4.404149474558272, -51.48621531107346, -70.27414947455827],
                                   [0.0, 11.203347713287997, -4.404149474558272, -51.48621531107346, -70.27414947455827],
                                   [0.0, 11.203347713287997, -4.404149474558272, -51.48621531107346, -70.27414947455827],
                                   [0.0, 11.203347713287997, -4.404149474558272, -51.48621531107346, -70.27414947455827],
                                   [0.0, 11.206821247174759, -4.400819218868518, -51.482885055383704, -70.27081921886852],
                                   [0.0, 11.21375494136134, -4.394172105934334, -51.47623794244952, -70.26417210593434],
                                   [0.0, 11.690529346014468, -3.941879064974199, -51.05673986813878, -69.81187906497419],
                                   [0.0, 12.363730411892309, -3.309535128222011, -50.46521019444076, -69.17953512822201],
                                   [0.0, 13.539985573303916, -2.23693667002349, -49.520797726823346, -68.10693667002349],
                                   [0.0, 15.495546998674946, -0.5935702687730995, -48.29909245501177, -66.4635702687731],
                                   [0.0, 16.763905094431216, 0.30501278979061563, -48.16510746164532, -65.56498721020938],
                                   [0.0, 17.384600502396975, 0.6325625120013187, -48.60020346940478, -65.83355085518728],
                                   [0.0, 18.00628590169047, 0.6871669252071246, -49.68529985664287, -68.72198278137526],
                                   [0.0, 18.23282067979907, 0.6055745708111555, -50.00634788457385, -69.91993327253086],
                                   [0.0, 18.413994224870102, 0.4994238875979349, -50.22846463301199, -70.76797340822102],
                                   [0.0, 18.49521551258678, 0.4672077590118242, -50.29907722555954, -70.95637735006716],
                                   [0.0, 18.467891083672743, 0.41963049947575026, -50.332868606576284, -71.055394395057],
                                   [0.0, 18.555715760755803, 0.09594258323011129, -50.346906989826245, -71.06122065071435],
                                   [0.0, 18.537370267551985, -0.8516712446550354, -50.37636741312845, -71.15207207028382],
                                   [0.0, 18.58338818933575, -1.5032951988535208, -50.364605958941056, -71.1446379494235],
                                   [0.0, 18.616673328505556, -2.317082946354355, -50.50610893299035, -71.21040057427969],
                                   [0.0, 18.67028096453628, -3.033366505338412, -50.594420601511125, -71.11554090482048],
                                   [0.0, 18.73957538628512, -3.4210448605776467, -50.588137182358764, -71.03278645132474],
                                   [0.0, 18.73586644035503, -3.9371539405955462, -50.5609792324267, -71.07799198701098],
                                   [0.0, 18.777169027429643, -4.631787820912919, -50.7830364139686, -71.07364433918534],
                                   [0.0, 18.774904522117314, -4.729766750521653, -50.837528140706056, -71.05370308186494],
                                   [0.0, 18.813090689694334, -4.78237033526951, -50.790967279321656, -71.05318576530134]])
        old_eoffs = self.old_eoffs
        sampling_stat = self.sampling_stat


        new_eoffs = eds_eoff_rebalancing.rebalance_eoffs_directCounting(old_eoffs=old_eoffs,
                                                            sampling_stat=sampling_stat,
                                                            correct_for_s1_only=False)
        print(list(map(list, new_eoffs)))
        np.testing.assert_almost_equal(actual=new_eoffs, desired=expected_eoffs, decimal=5)
