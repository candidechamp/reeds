

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>reeds.function_libs.pipeline.worker_scripts.analysis_workers.RE_EDS_general_analysis &mdash; REEDS  documentation</title>
  

  
  <link rel="stylesheet" href="../../../../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../../../../_static/pygments.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../../../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../../../../" src="../../../../../../_static/documentation_options.js"></script>
        <script src="../../../../../../_static/jquery.js"></script>
        <script src="../../../../../../_static/underscore.js"></script>
        <script src="../../../../../../_static/doctools.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    
    <script type="text/javascript" src="../../../../../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../../../../index.html" class="icon icon-home"> REEDS
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../introduction.html">REEDS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../Examples/index.html">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../_source/modules.html">reeds</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../../../index.html">REEDS</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../../../../index.html">Module code</a> &raquo;</li>
        
      <li>reeds.function_libs.pipeline.worker_scripts.analysis_workers.RE_EDS_general_analysis</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for reeds.function_libs.pipeline.worker_scripts.analysis_workers.RE_EDS_general_analysis</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">glob</span><span class="o">,</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">OrderedDict</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Union</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span>

<span class="kn">from</span> <span class="nn">pygromos.files</span> <span class="kn">import</span> <span class="n">imd</span><span class="p">,</span> <span class="n">repdat</span>
<span class="kn">from</span> <span class="nn">pygromos.utils</span> <span class="kn">import</span> <span class="n">bash</span>

<span class="kn">import</span> <span class="nn">reeds.function_libs.analysis.free_energy</span>
<span class="kn">import</span> <span class="nn">reeds.function_libs.analysis.parameter_optimization</span>
<span class="kn">import</span> <span class="nn">reeds.function_libs.analysis.sampling</span> <span class="k">as</span> <span class="nn">sampling_ana</span>
<span class="kn">import</span> <span class="nn">reeds.function_libs.optimization.eds_energy_offsets</span> <span class="k">as</span> <span class="nn">eds_energy_offsets</span>

<span class="kn">import</span> <span class="nn">reeds.function_libs.visualization.pot_energy_plots</span>
<span class="kn">import</span> <span class="nn">reeds.function_libs.visualization.re_plots</span>

<span class="kn">from</span> <span class="nn">reeds.function_libs.file_management</span> <span class="kn">import</span> <span class="n">file_management</span>
<span class="kn">from</span> <span class="nn">reeds.function_libs.file_management.file_management</span> <span class="kn">import</span> <span class="n">parse_csv_energy_trajectories</span>
<span class="kn">from</span> <span class="nn">reeds.function_libs.utils</span> <span class="kn">import</span> <span class="n">s_log_dist</span> <span class="k">as</span> <span class="n">sdist</span>
<span class="kn">from</span> <span class="nn">reeds.function_libs.utils.structures</span> <span class="kn">import</span> <span class="n">adding_Scheme_new_Replicas</span>

<span class="n">template_control_dict</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">({</span>  <span class="c1"># this dictionary is controlling the post  Simulation analysis procedure!</span>
    <span class="s2">&quot;concat&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;do&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
               <span class="s2">&quot;sub&quot;</span><span class="p">:</span> <span class="p">{</span>
                   <span class="s2">&quot;cp_cnf&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                   <span class="s2">&quot;cat_trc&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                   <span class="s2">&quot;cat_tre&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                   <span class="s2">&quot;ene_ana&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                   <span class="s2">&quot;convert_trcs&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                   <span class="s2">&quot;cat_repdat&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="p">}</span>
               <span class="p">},</span>
    <span class="s2">&quot;plot_property_timeseries&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;do&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                                 <span class="s2">&quot;sub&quot;</span><span class="p">:</span> <span class="p">{</span>
                                    <span class="s2">&quot;pot_ene_by_state&quot;</span><span class="p">:</span><span class="kc">True</span><span class="p">,</span>
                                    <span class="s2">&quot;pot_ene_by_replica&quot;</span><span class="p">:</span><span class="kc">False</span><span class="p">,</span>
                                    <span class="s2">&quot;pot_ene_timeseries&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                                    <span class="s2">&quot;pot_ene_grid_timeseries&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                                    <span class="s2">&quot;ref_timeseries&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                                    <span class="s2">&quot;ref_distrib&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                                    <span class="s2">&quot;distance_restraints&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                                    <span class="s2">&quot;temperature_2d_plot&quot;</span><span class="p">:</span> <span class="kc">False</span>
                                  <span class="p">}</span>
                                 <span class="p">},</span>
    <span class="s2">&quot;eoffset&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;do&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                <span class="s2">&quot;sub&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;calc_eoff&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                    <span class="s2">&quot;sampling_plot&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="p">}</span>
                <span class="p">},</span>
    <span class="s2">&quot;sopt&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;do&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
             <span class="s2">&quot;sub&quot;</span><span class="p">:</span> <span class="p">{</span>
                 <span class="s2">&quot;detect_flow_equilib&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                 <span class="s2">&quot;run_RTO&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                 <span class="s2">&quot;run_NLRTO&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                 <span class="s2">&quot;run_NGRTO&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                 <span class="s2">&quot;visualize_transitions&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                 <span class="s2">&quot;roundtrips&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                 <span class="s2">&quot;generate_replica trace&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
             <span class="p">},</span>
    <span class="s2">&quot;phys_sampling&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;do&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">},</span>
    <span class="s2">&quot;dfmult&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;do&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">},</span>
    <span class="s2">&quot;compress_simulation_folder&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;do&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">},</span>
    <span class="s2">&quot;prepare_input_folder&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;do&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                             <span class="s2">&quot;sub&quot;</span><span class="p">:</span> <span class="p">{</span>
                                 <span class="s2">&quot;eoff_to_sopt&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                                 <span class="s2">&quot;write_eoff&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                                 <span class="s2">&quot;write_s&quot;</span><span class="p">:</span> <span class="kc">True</span>
                             <span class="p">},</span>
                             <span class="p">}</span>
<span class="p">})</span>


<div class="viewcode-block" id="dict_to_nice_string"><a class="viewcode-back" href="../../../../../../_source/reeds.function_libs.pipeline.worker_scripts.analysis_workers.html#reeds.function_libs.pipeline.worker_scripts.analysis_workers.RE_EDS_general_analysis.dict_to_nice_string">[docs]</a><span class="k">def</span> <span class="nf">dict_to_nice_string</span><span class="p">(</span><span class="n">control_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Converts a dictionary of options (like template_control_dict)</span>
<span class="sd">	  to a more human readable format. Which can then be printed to a text file,</span>
<span class="sd">	  which can be manually modified before submiting analysis jobs.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    control_dict : Dict</span>
<span class="sd">        analysis control dictonary</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    str</span>
<span class="sd">        nice formatting of the control dictionary for printing.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">script_text</span> <span class="o">=</span> <span class="s2">&quot;control_dict = {</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">control_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">script_text</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\t\&quot;</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">key</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2">: &quot;</span>
        <span class="n">first</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="s2">&quot;do&quot;</span> <span class="ow">in</span> <span class="n">value</span><span class="p">):</span>  <span class="c1"># do should always be first in this list</span>
                <span class="n">script_text</span> <span class="o">+=</span> <span class="s2">&quot;{</span><span class="se">\&quot;</span><span class="s2">do</span><span class="se">\&quot;</span><span class="s2">:&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="s2">&quot;do&quot;</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span>
                <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="n">script_text</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="n">first</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">for</span> <span class="n">key2</span><span class="p">,</span> <span class="n">value2</span> <span class="ow">in</span> <span class="n">value</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>  <span class="c1"># alternative keys</span>

                <span class="c1"># prefix</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">first</span><span class="p">):</span>
                    <span class="n">prefix</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span>
                    <span class="n">first</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">prefix</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\t\t</span><span class="s2">&quot;</span>

                <span class="c1"># key_val</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">key2</span> <span class="o">==</span> <span class="s2">&quot;do&quot;</span><span class="p">):</span>
                    <span class="k">continue</span>
                <span class="k">elif</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">value2</span><span class="p">)</span> <span class="o">==</span> <span class="nb">dict</span><span class="p">):</span>
                    <span class="n">script_text</span> <span class="o">+=</span> <span class="n">prefix</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">key2</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2">: &quot;</span> <span class="o">+</span> <span class="n">_inline_dict</span><span class="p">(</span><span class="n">value2</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\t\t\t</span><span class="s2">&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;,</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">script_text</span> <span class="o">+=</span> <span class="n">prefix</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">key2</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2">: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">value2</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span>
            <span class="n">script_text</span> <span class="o">+=</span> <span class="n">prefix</span> <span class="o">+</span> <span class="s2">&quot; },</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">script_text</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;,</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="n">script_text</span> <span class="o">+=</span> <span class="s2">&quot;}</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="k">return</span> <span class="n">script_text</span></div>


<div class="viewcode-block" id="_inline_dict"><a class="viewcode-back" href="../../../../../../_source/reeds.function_libs.pipeline.worker_scripts.analysis_workers.html#reeds.function_libs.pipeline.worker_scripts.analysis_workers.RE_EDS_general_analysis._inline_dict">[docs]</a><span class="k">def</span> <span class="nf">_inline_dict</span><span class="p">(</span><span class="n">in_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">prefix</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        translate dictionary to one code line. can be used for meta-scripting</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    in_dict: Dict</span>
<span class="sd">        analysis control dict</span>
<span class="sd">    prefix : str, optional</span>
<span class="sd">        prfix symbol to dict write out.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    str</span>
<span class="sd">        code line.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;{</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">in_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="n">prefix</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2">: &quot;</span> <span class="o">+</span> <span class="n">_inline_dict</span><span class="p">(</span><span class="n">in_dict</span><span class="o">=</span><span class="n">value</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="n">prefix</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="n">prefix</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2">: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;,</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="k">return</span> <span class="n">msg</span> <span class="o">+</span> <span class="n">prefix</span> <span class="o">+</span> <span class="s2">&quot;}&quot;</span></div>


<div class="viewcode-block" id="check_script_control"><a class="viewcode-back" href="../../../../../../_source/reeds.function_libs.pipeline.worker_scripts.analysis_workers.html#reeds.function_libs.pipeline.worker_scripts.analysis_workers.RE_EDS_general_analysis.check_script_control">[docs]</a><span class="k">def</span> <span class="nf">check_script_control</span><span class="p">(</span><span class="n">control_dict</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">control_dict</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">)):</span>
        <span class="k">return</span> <span class="n">template_control_dict</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">template_control_dict</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">control_dict</span><span class="p">:</span>
                <span class="n">control_dict</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">x</span><span class="p">:</span> <span class="n">template_control_dict</span><span class="p">[</span><span class="n">x</span><span class="p">]})</span>
    <span class="k">return</span> <span class="n">control_dict</span></div>

<div class="viewcode-block" id="do_Reeds_analysis"><a class="viewcode-back" href="../../../../../../_source/reeds.function_libs.pipeline.worker_scripts.analysis_workers.html#reeds.function_libs.pipeline.worker_scripts.analysis_workers.RE_EDS_general_analysis.do_Reeds_analysis">[docs]</a><span class="k">def</span> <span class="nf">do_Reeds_analysis</span><span class="p">(</span><span class="n">in_folder</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">out_folder</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">gromos_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                      <span class="n">topology</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">in_ene_ana_lib</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">in_imd</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                      <span class="n">optimized_eds_state_folder</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;../a_optimizedState/analysis/data&quot;</span><span class="p">,</span>
                      <span class="n">state_undersampling_occurrence_potential_threshold</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                      <span class="n">state_physical_occurrence_potential_threshold</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                      <span class="n">undersampling_frac_thresh</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.9</span><span class="p">,</span>
                      <span class="n">add_s_vals</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">state_weights</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">s_opt_trial_range</span><span class="p">:</span><span class="nb">int</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                      <span class="n">adding_new_sReplicas_Scheme</span><span class="p">:</span> <span class="n">adding_Scheme_new_Replicas</span> <span class="o">=</span> <span class="n">adding_Scheme_new_Replicas</span><span class="o">.</span><span class="n">from_below</span><span class="p">,</span>
                      <span class="n">grom_file_prefix</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;test&quot;</span><span class="p">,</span> <span class="n">title_prefix</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;test&quot;</span><span class="p">,</span> <span class="n">ene_ana_prefix</span><span class="o">=</span><span class="s2">&quot;ey_sx.dat&quot;</span><span class="p">,</span>
                      <span class="n">repdat_prefix</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;run_repdat.dat&quot;</span><span class="p">,</span>
                      <span class="n">n_processors</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">dfmult_all_replicas</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                      <span class="n">control_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">(</span>
        <span class="nb">dict</span><span class="p">,</span> <span class="nb">dict</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">         Master calling point from which all jobs can call the analysis functions for a RE-EDS simulation.</span>
<span class="sd">	  This function generates: plots, compress files, and/or calculate values of interest.</span>


<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    in_folder : str</span>
<span class="sd">        input folder for the simulation.</span>
<span class="sd">    out_folder : str</span>
<span class="sd">        output folder for the simulation</span>
<span class="sd">    gromos_path : str</span>
<span class="sd">        gromosPP binary path</span>
<span class="sd">    topology : str</span>
<span class="sd">        path to topology</span>
<span class="sd">    in_ene_ana_lib : str</span>
<span class="sd">        in path for ene_ana lib</span>
<span class="sd">    in_imd : str</span>
<span class="sd">        in path for imd_file</span>
<span class="sd">    optimized_eds_state_folder : str, optional</span>
<span class="sd">        path to optimized eds_state folders (default: &quot;../a_optimizedState/analysis/data&quot;)</span>
<span class="sd">    pot_tresh : float, optional</span>
<span class="sd">        potential energy treshold (default: 0)</span>
<span class="sd">    undersampling_frac_thresh : int, optional</span>
<span class="sd">        fraction threshold (default: 0.6)</span>
<span class="sd">    take_last_n : int, optional</span>
<span class="sd">        this parameter can be used to force the energy offset estimation to use a certain amount of replicas.  (default: None)</span>
<span class="sd">    add_s_vals : int, optional</span>
<span class="sd">        this parameter can be used to add a number of s-values  during the s-optimization (default: 0)</span>
<span class="sd">    state_weights : List[float], optional</span>
<span class="sd">        allows to weight the different states in the s-optimization differently (default: None)</span>
<span class="sd">    s_opt_trial_range : int, optional</span>
<span class="sd">        give a range of trials, that define the start and end of the s-optimization run (default: adding_Scheme_new_Replicas.from_below)</span>
<span class="sd">    adding_new_sReplicas_Scheme : int, optional</span>
<span class="sd">        how shall the coordinates for new replicas be added to an exchange bottle-neck. (default: adding_Scheme_new_Replicas.from_below)</span>
<span class="sd">    grom_file_prefix : str, optional</span>
<span class="sd">         provide here a gromos_file prefix of this run (default: test)</span>
<span class="sd">    title_prefix : str, optional</span>
<span class="sd">        proivde here a output_prefx and plot prefix (default: test)</span>
<span class="sd">    ene_ana_prefix : str, optional</span>
<span class="sd">        prefix for the ene ana analysis @WARNING: NOT USED ANYMORE! - FUTURE REMOVE!.</span>
<span class="sd">    repdat_prefix : str, optional</span>
<span class="sd">        prefix for the repdat files. required to read in the repdats. (default:run_repdat.dat )</span>
<span class="sd">    n_processors : int, optional</span>
<span class="sd">        number of processors</span>
<span class="sd">    verbose : bool, optional</span>
<span class="sd">        verbosity level</span>
<span class="sd">    dfmult_all_replicas : bool, optional</span>
<span class="sd">        shall dfmult be calculated for all replicas</span>
<span class="sd">    control_dict : dict, optional</span>
<span class="sd">        control dict for analysis</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    (dict, dict, dict)</span>
<span class="sd">        eoff_statistic, svals, dFs - the function returns the eoff_statistics,</span>
<span class="sd">        the s-values of the s-optimization-results and the free energy calculation results,</span>
<span class="sd">        if calculated.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">eoff_statistic</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">svals</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">dFs</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Starting RE-EDS analysis:&quot;</span><span class="p">)</span>

    <span class="c1"># subfolder for clearer structure</span>
    <span class="n">plot_folder_path</span> <span class="o">=</span> <span class="n">out_folder</span> <span class="o">+</span> <span class="s2">&quot;/plots&quot;</span>
    <span class="n">concat_file_folder</span> <span class="o">=</span> <span class="n">bash</span><span class="o">.</span><span class="n">make_folder</span><span class="p">(</span><span class="n">out_folder</span> <span class="o">+</span> <span class="s2">&quot;/data&quot;</span><span class="p">,</span> <span class="s2">&quot;-p&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">out_folder</span><span class="p">)):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Generating out_folder: &quot;</span><span class="p">,</span> <span class="n">out_folder</span><span class="p">)</span>
        <span class="n">bash</span><span class="o">.</span><span class="n">make_folder</span><span class="p">(</span><span class="n">out_folder</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">concat_file_folder</span><span class="p">)):</span>
        <span class="n">bash</span><span class="o">.</span><span class="n">make_folder</span><span class="p">(</span><span class="n">concat_file_folder</span><span class="p">)</span>

    <span class="c1"># out_files</span>
    <span class="n">repdat_file_out_path</span> <span class="o">=</span> <span class="n">concat_file_folder</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">title_prefix</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">repdat_prefix</span>
    <span class="n">ene_trajs_prefix</span> <span class="o">=</span> <span class="n">title_prefix</span> <span class="o">+</span> <span class="s2">&quot;_energies&quot;</span>

    <span class="c1"># manual script control</span>
    <span class="n">control_dict</span> <span class="o">=</span> <span class="n">check_script_control</span><span class="p">(</span><span class="n">control_dict</span><span class="p">)</span>

    <span class="c1"># parameter file: &lt;-not needed!</span>
    <span class="c1"># if(verbose): print(&quot;Reading imd: &quot;+in_imd)</span>
    <span class="n">imd_file</span> <span class="o">=</span> <span class="n">imd</span><span class="o">.</span><span class="n">Imd</span><span class="p">(</span><span class="n">in_imd</span><span class="p">)</span>
    <span class="n">s_values</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="n">imd_file</span><span class="o">.</span><span class="n">REPLICA_EDS</span><span class="o">.</span><span class="n">RES</span><span class="p">))</span>
    <span class="n">Eoff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">vec</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="n">vec</span><span class="p">)),</span> <span class="n">imd_file</span><span class="o">.</span><span class="n">REPLICA_EDS</span><span class="o">.</span><span class="n">EIR</span><span class="p">)))</span><span class="o">.</span><span class="n">T</span>
    <span class="n">num_states</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">imd_file</span><span class="o">.</span><span class="n">REPLICA_EDS</span><span class="o">.</span><span class="n">NUMSTATES</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">imd_file</span><span class="o">.</span><span class="n">MULTIBATH</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">))):</span>
            <span class="n">temp</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">imd_file</span><span class="o">.</span><span class="n">MULTIBATH</span><span class="o">.</span><span class="n">TEMP0</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">elif</span> <span class="p">(</span><span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">imd_file</span><span class="o">.</span><span class="n">STOCHDYN</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">))):</span>
            <span class="n">temp</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">imd_file</span><span class="o">.</span><span class="n">STOCHDYN</span><span class="o">.</span><span class="n">TEMPSD</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Either STOCHDYN or MULTIBATH block needs to be defined in imd.&quot;</span><span class="p">)</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Failed during analysis</span><span class="se">\n\t</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n\t</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">err</span><span class="o">.</span><span class="n">args</span><span class="p">)))</span>
        <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">control_dict</span><span class="p">[</span><span class="s2">&quot;concat&quot;</span><span class="p">][</span><span class="s2">&quot;do&quot;</span><span class="p">]):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;STARTING CONCATENATION.&quot;</span><span class="p">)</span>
        <span class="n">num_replicas</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">s_values</span><span class="p">)</span>

        <span class="c1"># if we&#39;re using Stochastic Dynamics, use solutemp2 for ene_ana instead of solvtemp2</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">imd_file</span><span class="o">.</span><span class="n">MULTIBATH</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">))</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">imd_file</span><span class="o">.</span><span class="n">STOCHDYN</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">))):</span>
            <span class="n">additional_properties</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;solutemp2&quot;</span><span class="p">,</span> <span class="s2">&quot;totdisres&quot;</span><span class="p">)</span>
            <span class="n">boundary_conditions</span> <span class="o">=</span> <span class="s2">&quot;v cog&quot;</span>

        <span class="c1"># if there&#39;s only one bath, use solutemp2 for ene_ana instead of solvtemp2</span>
        <span class="k">elif</span> <span class="p">(</span><span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">imd_file</span><span class="o">.</span><span class="n">MULTIBATH</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">))</span> <span class="ow">and</span> <span class="n">imd_file</span><span class="o">.</span><span class="n">MULTIBATH</span><span class="o">.</span><span class="n">NBATHS</span> <span class="o">==</span> <span class="s2">&quot;1&quot;</span><span class="p">):</span>
            <span class="n">additional_properties</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;solutemp2&quot;</span><span class="p">,</span> <span class="s2">&quot;totdisres&quot;</span><span class="p">)</span>
            <span class="n">boundary_conditions</span> <span class="o">=</span> <span class="s2">&quot;r cog&quot;</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">additional_properties</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;solvtemp2&quot;</span><span class="p">,</span> <span class="s2">&quot;totdisres&quot;</span><span class="p">)</span>
            <span class="n">boundary_conditions</span> <span class="o">=</span> <span class="s2">&quot;r cog&quot;</span>

        <span class="n">out_files</span> <span class="o">=</span> <span class="n">file_management</span><span class="o">.</span><span class="n">reeds_project_concatenation</span><span class="p">(</span><span class="n">in_folder</span><span class="o">=</span><span class="n">in_folder</span><span class="p">,</span> <span class="n">in_topology_path</span><span class="o">=</span><span class="n">topology</span><span class="p">,</span>
                                                                <span class="n">in_imd</span><span class="o">=</span><span class="n">in_imd</span><span class="p">,</span> <span class="n">num_replicas</span><span class="o">=</span><span class="n">num_replicas</span><span class="p">,</span>
                                                                <span class="n">control_dict</span><span class="o">=</span><span class="n">control_dict</span><span class="p">[</span><span class="s2">&quot;concat&quot;</span><span class="p">][</span><span class="s2">&quot;sub&quot;</span><span class="p">],</span>
                                                                <span class="n">out_folder</span><span class="o">=</span><span class="n">concat_file_folder</span><span class="p">,</span>
                                                                <span class="n">in_ene_ana_lib_path</span><span class="o">=</span><span class="n">in_ene_ana_lib</span><span class="p">,</span>
                                                                <span class="n">repdat_file_out_path</span><span class="o">=</span><span class="n">repdat_file_out_path</span><span class="p">,</span>
                                                                <span class="n">out_file_prefix</span><span class="o">=</span><span class="n">grom_file_prefix</span><span class="p">,</span> <span class="n">starting_time</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                                                <span class="n">n_processes</span><span class="o">=</span><span class="n">n_processors</span><span class="p">,</span> <span class="n">gromosPP_bin_dir</span><span class="o">=</span><span class="n">gromos_path</span><span class="p">,</span>
                                                                <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                                                <span class="n">additional_properties</span><span class="o">=</span><span class="n">additional_properties</span><span class="p">,</span>
                                                                <span class="n">boundary_conditions</span><span class="o">=</span><span class="n">boundary_conditions</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">verbose</span><span class="p">):</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Done</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># intermezzo generating plots_folder</span>
    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">plot_folder_path</span><span class="p">)):</span>
        <span class="n">plot_folder_path</span> <span class="o">=</span> <span class="n">bash</span><span class="o">.</span><span class="n">make_folder</span><span class="p">(</span><span class="n">plot_folder_path</span><span class="p">)</span>

    <span class="c1"># Set this to None as a checker to avoid redundant parsing</span>
    <span class="n">energy_trajectories</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">control_dict</span><span class="p">[</span><span class="s2">&quot;plot_property_timeseries&quot;</span><span class="p">][</span><span class="s2">&quot;do&quot;</span><span class="p">]):</span>
        <span class="n">sub_control</span> <span class="o">=</span> <span class="n">control_dict</span><span class="p">[</span><span class="s2">&quot;plot_property_timeseries&quot;</span><span class="p">][</span><span class="s2">&quot;sub&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">verbose</span><span class="p">):</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">Parse the data:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="c1"># No need to check if trajectories are parsed here, as it is the first access point. </span>
        <span class="n">energy_trajectories</span> <span class="o">=</span> <span class="n">parse_csv_energy_trajectories</span><span class="p">(</span><span class="n">concat_file_folder</span><span class="p">,</span> <span class="n">ene_trajs_prefix</span><span class="p">)</span>
        
        <span class="c1"># Plots related to the potential energy distributions of the end states.</span>

        <span class="k">if</span> <span class="n">sub_control</span><span class="p">[</span><span class="s2">&quot;pot_ene_by_state&quot;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">verbose</span><span class="p">):</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\t</span><span class="s2">Plotting end state potential energy distributions (by state)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>        
            <span class="k">for</span> <span class="n">state_num</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_states</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">outfile</span> <span class="o">=</span> <span class="n">plot_folder_path</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">title_prefix</span> <span class="o">+</span> <span class="s1">&#39;_pot_ene_state_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">state_num</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.png&#39;</span>
                <span class="n">reeds</span><span class="o">.</span><span class="n">function_libs</span><span class="o">.</span><span class="n">visualization</span><span class="o">.</span><span class="n">pot_energy_plots</span><span class="o">.</span><span class="n">plot_energy_distribution_by_state</span><span class="p">(</span><span class="n">energy_trajectories</span><span class="p">,</span> <span class="n">outfile</span><span class="p">,</span> <span class="n">state_num</span><span class="p">,</span> <span class="n">s_values</span><span class="p">,</span>
                                                                                                     <span class="n">manual_xlim</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">shared_xaxis</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">sub_control</span><span class="p">[</span><span class="s2">&quot;pot_ene_by_replica&quot;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">verbose</span><span class="p">):</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\t</span><span class="s2">Plotting end state potential energy distributions (by replica)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">replica_num</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">energy_trajectories</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">outfile</span> <span class="o">=</span>  <span class="n">plot_folder_path</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">title_prefix</span> <span class="o">+</span> <span class="s1">&#39;_pot_ene_replica_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">replica_num</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.png&#39;</span>
                <span class="n">reeds</span><span class="o">.</span><span class="n">function_libs</span><span class="o">.</span><span class="n">visualization</span><span class="o">.</span><span class="n">pot_energy_plots</span><span class="o">.</span><span class="n">plot_energy_distribution_by_replica</span><span class="p">(</span><span class="n">energy_trajectories</span><span class="p">[</span><span class="n">replica_num</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span> <span class="n">outfile</span><span class="p">,</span>
                                                                                                       <span class="n">replica_num</span><span class="p">,</span> <span class="n">s_values</span><span class="p">[</span><span class="n">replica_num</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                                                                                                       <span class="n">manual_xlim</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">shared_xaxis</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
        
        <span class="c1"># this variable allows to access particular elements in the pandas DataFrame</span>
        <span class="n">singleStates</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;e&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_states</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span>
        
        <span class="c1"># Timeseries of the potential energy of the end states.</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ene_traj</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">energy_trajectories</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">sub_control</span><span class="p">[</span><span class="s2">&quot;pot_ene_timeseries&quot;</span><span class="p">]:</span>
                <span class="n">out_path</span> <span class="o">=</span> <span class="n">plot_folder_path</span> <span class="o">+</span> <span class="s2">&quot;/edsState_potential_timeseries_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">ene_traj</span><span class="o">.</span><span class="n">s</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.png&quot;</span>
                <span class="n">reeds</span><span class="o">.</span><span class="n">function_libs</span><span class="o">.</span><span class="n">visualization</span><span class="o">.</span><span class="n">pot_energy_plots</span><span class="o">.</span><span class="n">plot_potential_timeseries</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="n">ene_traj</span><span class="o">.</span><span class="n">time</span><span class="p">,</span> <span class="n">potentials</span><span class="o">=</span><span class="n">ene_traj</span><span class="p">[</span><span class="n">singleStates</span><span class="p">],</span>
                                                                                             <span class="n">y_range</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">1000</span><span class="p">),</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;EDS_stateV_scatter&quot;</span><span class="p">,</span>
                                                                                             <span class="n">out_path</span><span class="o">=</span><span class="n">out_path</span><span class="p">)</span>
             
            <span class="k">if</span> <span class="n">sub_control</span><span class="p">[</span><span class="s2">&quot;pot_ene_grid_timeseries&quot;</span><span class="p">]:</span>
                <span class="n">out_path</span> <span class="o">=</span> <span class="n">plot_folder_path</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">title_prefix</span> <span class="o">+</span> <span class="s1">&#39;_pot_ene_timeseries_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.png&#39;</span>
                <span class="n">title</span> <span class="o">=</span> <span class="n">title_prefix</span> <span class="o">+</span> <span class="s1">&#39; potential energy timeseries - s = &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">s_values</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="n">reeds</span><span class="o">.</span><span class="n">function_libs</span><span class="o">.</span><span class="n">visualization</span><span class="o">.</span><span class="n">pot_energy_plots</span><span class="o">.</span><span class="n">plot_sampling_grid</span><span class="p">(</span><span class="n">traj_data</span> <span class="o">=</span> <span class="n">ene_traj</span><span class="p">,</span> <span class="n">y_range</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">1000</span><span class="p">),</span> <span class="n">out_path</span><span class="o">=</span><span class="n">out_path</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">)</span>

        <span class="c1"># Plots related to the reference potential energy (V_R)</span>

        <span class="k">if</span> <span class="n">sub_control</span><span class="p">[</span><span class="s2">&quot;ref_timeseries&quot;</span><span class="p">]:</span>
            <span class="n">outfile</span> <span class="o">=</span> <span class="n">plot_folder_path</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">title_prefix</span> <span class="o">+</span> <span class="s1">&#39;_ref_pot_ene_timeseries.png&#39;</span>
            <span class="n">reeds</span><span class="o">.</span><span class="n">function_libs</span><span class="o">.</span><span class="n">visualization</span><span class="o">.</span><span class="n">pot_energy_plots</span><span class="o">.</span><span class="n">plot_ref_pot_ene_timeseries</span><span class="p">(</span><span class="n">energy_trajectories</span><span class="p">,</span> <span class="n">outfile</span><span class="p">,</span> <span class="n">s_values</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">sub_control</span><span class="p">[</span><span class="s2">&quot;ref_distrib&quot;</span><span class="p">]:</span>
            <span class="n">outfile</span> <span class="o">=</span> <span class="n">plot_folder_path</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">title_prefix</span> <span class="o">+</span> <span class="s1">&#39;_ref_pot_ene_distrib.png&#39;</span>
            <span class="n">reeds</span><span class="o">.</span><span class="n">function_libs</span><span class="o">.</span><span class="n">visualization</span><span class="o">.</span><span class="n">pot_energy_plots</span><span class="o">.</span><span class="n">plot_ref_pot_energy_distribution</span><span class="p">(</span><span class="n">energy_trajectories</span><span class="p">,</span> <span class="n">outfile</span><span class="p">,</span> <span class="n">s_values</span><span class="p">)</span>
            
        <span class="k">if</span> <span class="p">(</span><span class="n">sub_control</span><span class="p">[</span><span class="s2">&quot;distance_restraints&quot;</span><span class="p">]):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">verbose</span><span class="p">):</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">PLOT Disres_bias timeseries:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">ene_traj</span> <span class="ow">in</span> <span class="n">energy_trajectories</span><span class="p">:</span>
                <span class="c1"># plot disres_contrib:</span>
                <span class="n">out_path</span> <span class="o">=</span> <span class="n">plot_folder_path</span> <span class="o">+</span> <span class="s2">&quot;/distance_restraints_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">ene_traj</span><span class="o">.</span><span class="n">s</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.png&quot;</span>
                <span class="n">singleStates</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;totdisres&quot;</span><span class="p">]</span>

                <span class="n">reeds</span><span class="o">.</span><span class="n">function_libs</span><span class="o">.</span><span class="n">visualization</span><span class="o">.</span><span class="n">pot_energy_plots</span><span class="o">.</span><span class="n">plot_potential_timeseries</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="n">ene_traj</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">],</span> <span class="n">potentials</span><span class="o">=</span><span class="n">ene_traj</span><span class="p">[</span><span class="n">singleStates</span><span class="p">],</span>
                                                                                             <span class="n">title</span><span class="o">=</span><span class="s2">&quot;EDS disres Potential s&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">ene_traj</span><span class="o">.</span><span class="n">s</span><span class="p">),</span> <span class="n">y_label</span><span class="o">=</span><span class="s2">&quot;E/[kj/mol]&quot;</span><span class="p">,</span>
                                                                                             <span class="n">x_label</span><span class="o">=</span><span class="s2">&quot;t/[ps]&quot;</span><span class="p">,</span>
                                                                                             <span class="n">out_path</span><span class="o">=</span><span class="n">out_path</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">sub_control</span><span class="p">[</span><span class="s2">&quot;temperature_2d_plot&quot;</span><span class="p">]):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">PLOT temperature 2D histogram:</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">imd_file</span><span class="o">.</span><span class="n">MULTIBATH</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">))</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">imd_file</span><span class="o">.</span><span class="n">STOCHDYN</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">))):</span>
                <span class="n">reeds</span><span class="o">.</span><span class="n">function_libs</span><span class="o">.</span><span class="n">visualization</span><span class="o">.</span><span class="n">pot_energy_plots</span><span class="o">.</span><span class="n">plot_replicaEnsemble_property_2D</span><span class="p">(</span><span class="n">ene_trajs</span><span class="o">=</span><span class="n">energy_trajectories</span><span class="p">,</span>
                                                                                                    <span class="n">out_path</span><span class="o">=</span><span class="n">plot_folder_path</span> <span class="o">+</span> <span class="s2">&quot;/temperature_heatMap.png&quot;</span><span class="p">,</span>
                                                                                                    <span class="n">temperature_property</span><span class="o">=</span><span class="s2">&quot;solutemp2&quot;</span><span class="p">)</span>

            <span class="k">elif</span> <span class="p">(</span><span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">imd_file</span><span class="o">.</span><span class="n">MULTIBATH</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">))</span> <span class="ow">and</span> <span class="n">imd_file</span><span class="o">.</span><span class="n">MULTIBATH</span><span class="o">.</span><span class="n">NBATHS</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">reeds</span><span class="o">.</span><span class="n">function_libs</span><span class="o">.</span><span class="n">visualization</span><span class="o">.</span><span class="n">pot_energy_plots</span><span class="o">.</span><span class="n">plot_replicaEnsemble_property_2D</span><span class="p">(</span><span class="n">ene_trajs</span><span class="o">=</span><span class="n">energy_trajectories</span><span class="p">,</span>
                                                                                                    <span class="n">out_path</span><span class="o">=</span><span class="n">plot_folder_path</span> <span class="o">+</span> <span class="s2">&quot;/temperature_heatMap.png&quot;</span><span class="p">,</span>
                                                                                                    <span class="n">temperature_property</span><span class="o">=</span><span class="s2">&quot;solutemp2&quot;</span><span class="p">)</span>
                
            <span class="k">else</span><span class="p">:</span>
                <span class="n">reeds</span><span class="o">.</span><span class="n">function_libs</span><span class="o">.</span><span class="n">visualization</span><span class="o">.</span><span class="n">pot_energy_plots</span><span class="o">.</span><span class="n">plot_replicaEnsemble_property_2D</span><span class="p">(</span><span class="n">ene_trajs</span><span class="o">=</span><span class="n">energy_trajectories</span><span class="p">,</span>
                                                                                                    <span class="n">out_path</span><span class="o">=</span><span class="n">plot_folder_path</span> <span class="o">+</span> <span class="s2">&quot;/temperature_heatMap.png&quot;</span><span class="p">,</span>
                                                                                                    <span class="n">temperature_property</span><span class="o">=</span><span class="s2">&quot;solvtemp2&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">verbose</span><span class="p">):</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;DONE</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="c1"># del energy_trajectories -- remove if memory without this is fine</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">control_dict</span><span class="p">[</span><span class="s2">&quot;eoffset&quot;</span><span class="p">][</span><span class="s2">&quot;do&quot;</span><span class="p">]):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Start Eoffset&quot;</span><span class="p">)</span>
        <span class="n">sub_control</span> <span class="o">=</span> <span class="n">control_dict</span><span class="p">[</span><span class="s2">&quot;eoffset&quot;</span><span class="p">][</span><span class="s2">&quot;sub&quot;</span><span class="p">]</span>
        <span class="n">out_dir</span> <span class="o">=</span> <span class="n">bash</span><span class="o">.</span><span class="n">make_folder</span><span class="p">(</span><span class="n">out_folder</span> <span class="o">+</span> <span class="s2">&quot;/eoff&quot;</span><span class="p">)</span>

        <span class="c1"># parsing_ene_traj_csvs </span>
        <span class="k">if</span> <span class="n">energy_trajectories</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">energy_trajectories</span> <span class="o">=</span> <span class="n">parse_csv_energy_trajectories</span><span class="p">(</span><span class="n">concat_file_folder</span><span class="p">,</span> <span class="n">ene_trajs_prefix</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">concat_file_folder</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s2">&quot;could not find needed energies (contains all ene ana .dats) folder in:</span><span class="se">\n</span><span class="s2"> &quot;</span> <span class="o">+</span> <span class="n">out_folder</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="p">(</span><span class="n">sub_control</span><span class="p">[</span><span class="s2">&quot;sampling_plot&quot;</span><span class="p">]):</span>
            <span class="c1"># plot if states are sampled and minimal state</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">plot sampling: &quot;</span><span class="p">)</span>
            <span class="p">(</span><span class="n">sampling_results</span><span class="p">,</span> <span class="n">out_dir</span><span class="p">)</span> <span class="o">=</span> <span class="n">sampling_ana</span><span class="o">.</span><span class="n">detect_undersampling</span><span class="p">(</span><span class="n">out_path</span> <span class="o">=</span> <span class="n">out_dir</span><span class="p">,</span> <span class="n">ene_traj_csvs</span> <span class="o">=</span> <span class="n">energy_trajectories</span><span class="p">,</span>
                                                                            <span class="n">s_values</span> <span class="o">=</span> <span class="n">s_values</span><span class="p">,</span> <span class="n">state_potential_treshold</span><span class="o">=</span> <span class="n">state_undersampling_occurrence_potential_threshold</span><span class="p">,</span> <span class="n">undersampling_occurence_sampling_tresh</span><span class="o">=</span><span class="n">undersampling_frac_thresh</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">sub_control</span><span class="p">[</span><span class="s2">&quot;calc_eoff&quot;</span><span class="p">]):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;calc Eoff: &quot;</span><span class="p">)</span>
            <span class="c1"># WARNING ASSUMPTION THAT ALL EOFF VECTORS ARE THE SAME!</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">Eoffs(&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Eoff</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="o">+</span> <span class="s2">&quot;): &quot;</span><span class="p">,</span> <span class="n">Eoff</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">S_values(&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">s_values</span><span class="p">))</span> <span class="o">+</span> <span class="s2">&quot;): &quot;</span><span class="p">,</span> <span class="n">s_values</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">sytsemTemp: &quot;</span><span class="p">,</span> <span class="n">temp</span><span class="p">)</span>
            <span class="c1"># set trim_beg to 0.1 when analysing non equilibrated data</span>
            <span class="n">new_eoffs</span><span class="p">,</span> <span class="n">all_eoffs</span> <span class="o">=</span> <span class="n">eds_energy_offsets</span><span class="o">.</span><span class="n">estimate_energy_offsets</span><span class="p">(</span><span class="n">ene_trajs</span> <span class="o">=</span> <span class="n">energy_trajectories</span><span class="p">,</span> <span class="n">initial_offsets</span> <span class="o">=</span> <span class="n">Eoff</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">sampling_stat</span><span class="o">=</span><span class="n">sampling_results</span><span class="p">,</span> <span class="n">s_values</span> <span class="o">=</span> <span class="n">s_values</span><span class="p">,</span>
                                                                              <span class="n">out_path</span> <span class="o">=</span> <span class="n">out_dir</span><span class="p">,</span> <span class="n">temp</span> <span class="o">=</span> <span class="n">temp</span><span class="p">,</span> <span class="n">trim_beg</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">,</span> <span class="n">undersampling_idx</span> <span class="o">=</span> <span class="n">sampling_results</span><span class="p">[</span><span class="s1">&#39;undersamplingThreshold&#39;</span><span class="p">],</span>
                                                                              <span class="n">plot_results</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">calc_clara</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="p">(</span><span class="n">verbose</span><span class="p">):</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Done</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">control_dict</span><span class="p">[</span><span class="s2">&quot;sopt&quot;</span><span class="p">][</span><span class="s2">&quot;do&quot;</span><span class="p">]):</span>
        <span class="n">sub_control</span> <span class="o">=</span> <span class="n">control_dict</span><span class="p">[</span><span class="s2">&quot;sopt&quot;</span><span class="p">][</span><span class="s2">&quot;sub&quot;</span><span class="p">]</span>
        <span class="n">out_dir</span> <span class="o">=</span> <span class="n">bash</span><span class="o">.</span><span class="n">make_folder</span><span class="p">(</span><span class="n">out_folder</span> <span class="o">+</span> <span class="s2">&quot;/s_optimization&quot;</span><span class="p">)</span>

        <span class="c1"># get repdat file</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">repdat_file_out_path</span><span class="p">)</span>
        <span class="n">in_file</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">repdat_file_out_path</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Found RepFILE: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">in_file</span><span class="p">))</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">sub_control</span><span class="p">[</span><span class="s2">&quot;run_RTO&quot;</span><span class="p">]):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Start Sopt</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;repdat_in_file: &quot;</span><span class="p">,</span> <span class="n">in_file</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">svals</span> <span class="o">=</span> <span class="n">reeds</span><span class="o">.</span><span class="n">function_libs</span><span class="o">.</span><span class="n">analysis</span><span class="o">.</span><span class="n">parameter_optimization</span><span class="o">.</span><span class="n">optimize_s</span><span class="p">(</span><span class="n">in_file</span><span class="o">=</span><span class="n">in_file</span><span class="p">,</span> <span class="n">out_dir</span><span class="o">=</span><span class="n">out_dir</span><span class="p">,</span>
                                                                                   <span class="n">title_prefix</span><span class="o">=</span><span class="s2">&quot;s_opt&quot;</span><span class="p">,</span> <span class="n">in_imd</span><span class="o">=</span><span class="n">in_imd</span><span class="p">,</span>
                                                                                   <span class="n">add_s_vals</span><span class="o">=</span><span class="n">add_s_vals</span><span class="p">,</span> <span class="n">trial_range</span><span class="o">=</span><span class="n">s_opt_trial_range</span><span class="p">,</span>
                                                                                   <span class="n">state_weights</span><span class="o">=</span><span class="n">state_weights</span><span class="p">,</span>
                                                                                   <span class="n">run_NLRTO</span><span class="o">=</span><span class="n">sub_control</span><span class="p">[</span><span class="s2">&quot;run_NLRTO&quot;</span><span class="p">],</span> <span class="n">run_NGRTO</span><span class="o">=</span><span class="n">sub_control</span><span class="p">[</span><span class="s2">&quot;run_NGRTO&quot;</span><span class="p">],</span>
                                                                                   <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">sub_control</span><span class="p">[</span><span class="s2">&quot;visualize_transitions&quot;</span><span class="p">]):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t\t</span><span class="s2">visualize transitions&quot;</span><span class="p">)</span>
            <span class="n">reeds</span><span class="o">.</span><span class="n">function_libs</span><span class="o">.</span><span class="n">analysis</span><span class="o">.</span><span class="n">parameter_optimization</span><span class="o">.</span><span class="n">get_s_optimization_transitions</span><span class="p">(</span><span class="n">out_dir</span><span class="o">=</span><span class="n">out_dir</span><span class="p">,</span> <span class="n">rep_dat</span><span class="o">=</span><span class="n">in_file</span><span class="p">,</span> <span class="n">title_prefix</span><span class="o">=</span><span class="n">title_prefix</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">sub_control</span><span class="p">[</span><span class="s2">&quot;roundtrips&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">sub_control</span><span class="p">[</span><span class="s2">&quot;run_RTO&quot;</span><span class="p">]):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t\t</span><span class="s2">show roundtrips&quot;</span><span class="p">)</span>
            <span class="n">in_repdat_file</span> <span class="o">=</span> <span class="n">repdat</span><span class="o">.</span><span class="n">Repdat</span><span class="p">(</span><span class="n">in_file</span><span class="p">)</span>

            <span class="c1"># retrieve data:</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;get replica transitions&quot;</span><span class="p">)</span>
            <span class="n">s_values</span> <span class="o">=</span> <span class="n">in_repdat_file</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">s</span>
            <span class="n">trans_dict</span> <span class="o">=</span> <span class="n">in_repdat_file</span><span class="o">.</span><span class="n">get_replica_traces</span><span class="p">()</span>

            <span class="c1"># plot</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Plotting Histogramm&quot;</span><span class="p">)</span>
            <span class="n">reeds</span><span class="o">.</span><span class="n">function_libs</span><span class="o">.</span><span class="n">visualization</span><span class="o">.</span><span class="n">re_plots</span><span class="o">.</span><span class="n">plot_repPos_replica_histogramm</span><span class="p">(</span><span class="n">out_path</span><span class="o">=</span><span class="n">out_dir</span> <span class="o">+</span> <span class="s2">&quot;/replica_repex_pos.png&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">trans_dict</span><span class="p">,</span>
                                                                                      <span class="n">title</span><span class="o">=</span><span class="n">title_prefix</span><span class="p">,</span>
                                                                                      <span class="n">s_values</span><span class="o">=</span><span class="n">s_values</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">verbose</span><span class="p">):</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Done</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">control_dict</span><span class="p">[</span><span class="s2">&quot;phys_sampling&quot;</span><span class="p">][</span><span class="s2">&quot;do&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">state_physical_occurrence_potential_threshold</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
        <span class="n">out_dir</span> <span class="o">=</span> <span class="n">bash</span><span class="o">.</span><span class="n">make_folder</span><span class="p">(</span><span class="n">out_folder</span> <span class="o">+</span> <span class="s2">&quot;/state_sampling&quot;</span><span class="p">)</span>

        <span class="p">(</span><span class="n">sampling_results</span><span class="p">,</span> <span class="n">out_dir</span><span class="p">)</span> <span class="o">=</span> <span class="n">sampling_ana</span><span class="o">.</span><span class="n">sampling_analysis</span><span class="p">(</span><span class="n">out_path</span><span class="o">=</span><span class="n">out_dir</span><span class="p">,</span>
                                                                     <span class="n">ene_traj_csvs</span><span class="o">=</span><span class="n">energy_trajectories</span><span class="p">,</span>
                                                                     <span class="n">s_values</span><span class="o">=</span><span class="n">s_values</span><span class="p">,</span>
                                                                     <span class="n">state_potential_treshold</span><span class="o">=</span><span class="n">state_physical_occurrence_potential_threshold</span><span class="p">)</span>
    <span class="k">elif</span><span class="p">(</span><span class="n">control_dict</span><span class="p">[</span><span class="s2">&quot;phys_sampling&quot;</span><span class="p">][</span><span class="s2">&quot;do&quot;</span><span class="p">]):</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;DID NOT do physical sampling analysis, as state_physical_occurrence_potential_threshold was None!&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">control_dict</span><span class="p">[</span><span class="s2">&quot;dfmult&quot;</span><span class="p">][</span><span class="s2">&quot;do&quot;</span><span class="p">]):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Start Dfmult&quot;</span><span class="p">)</span>

        <span class="c1"># check convergence:</span>
        <span class="n">dfmult_convergence_folder</span> <span class="o">=</span> <span class="n">out_folder</span> <span class="o">+</span> <span class="s2">&quot;/free_energy&quot;</span>
        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">dfmult_convergence_folder</span><span class="p">)):</span>
            <span class="n">bash</span><span class="o">.</span><span class="n">make_folder</span><span class="p">(</span><span class="n">dfmult_convergence_folder</span><span class="p">,</span> <span class="s2">&quot;-p&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">energy_trajectories</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">energy_trajectories</span> <span class="o">=</span> <span class="n">parse_csv_energy_trajectories</span><span class="p">(</span><span class="n">concat_file_folder</span><span class="p">,</span> <span class="n">ene_trajs_prefix</span><span class="p">)</span>

        <span class="n">reeds</span><span class="o">.</span><span class="n">function_libs</span><span class="o">.</span><span class="n">analysis</span><span class="o">.</span><span class="n">free_energy</span><span class="o">.</span><span class="n">free_energy_convergence_analysis</span><span class="p">(</span><span class="n">ene_ana_trajs</span><span class="o">=</span><span class="n">energy_trajectories</span><span class="p">,</span> <span class="n">out_dir</span><span class="o">=</span><span class="n">dfmult_convergence_folder</span><span class="p">,</span>
                                                                                  <span class="n">out_prefix</span><span class="o">=</span><span class="n">title_prefix</span><span class="p">,</span> <span class="n">in_prefix</span><span class="o">=</span><span class="n">ene_trajs_prefix</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span>
                                                                                  <span class="n">dfmult_all_replicas</span><span class="o">=</span><span class="n">dfmult_all_replicas</span><span class="p">)</span>

    <span class="c1"># When we reach here, we no longer need the data in energy_trajectories, memory can be freed.</span>
    <span class="k">del</span> <span class="n">energy_trajectories</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">control_dict</span><span class="p">[</span><span class="s2">&quot;prepare_input_folder&quot;</span><span class="p">][</span><span class="s2">&quot;do&quot;</span><span class="p">]):</span>
        <span class="n">sub_control</span> <span class="o">=</span> <span class="n">control_dict</span><span class="p">[</span><span class="s2">&quot;prepare_input_folder&quot;</span><span class="p">][</span><span class="s2">&quot;sub&quot;</span><span class="p">]</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;PREPARE NEXT FOLDER- for next run&quot;</span><span class="p">)</span>

        <span class="n">next_dir</span> <span class="o">=</span> <span class="n">bash</span><span class="o">.</span><span class="n">make_folder</span><span class="p">(</span><span class="n">out_folder</span> <span class="o">+</span> <span class="s2">&quot;/next&quot;</span><span class="p">,</span> <span class="s2">&quot;-p&quot;</span><span class="p">)</span>
        <span class="n">next_imd</span> <span class="o">=</span> <span class="n">next_dir</span> <span class="o">+</span> <span class="s2">&quot;/next.imd&quot;</span>

        <span class="c1"># add ne w cnf s for the new S-distribution</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;generating new Cnfs for new s_dist&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">sub_control</span><span class="p">[</span><span class="s2">&quot;eoff_to_sopt&quot;</span><span class="p">]):</span>  <span class="c1"># if the s_dist should be converted from eoff to sopt</span>
            <span class="n">new_sval</span> <span class="o">=</span> <span class="p">[</span><span class="n">s_values</span><span class="p">,</span> <span class="p">[]]</span>
            <span class="n">new_sval</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.0</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_states</span><span class="p">)]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span>
                <span class="n">sdist</span><span class="o">.</span><span class="n">get_log_s_distribution_between</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="n">s_values</span><span class="p">),</span> <span class="n">num</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">s_values</span><span class="p">)</span> <span class="o">-</span> <span class="mi">4</span><span class="p">))[</span>
                                                             <span class="mi">1</span><span class="p">:]</span>  <span class="c1"># todo: hardcoded make clever and do automatic!</span>
            <span class="n">svals</span> <span class="o">=</span> <span class="n">new_sval</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;new_s(&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">svals</span><span class="p">))</span> <span class="o">+</span> <span class="s2">&quot;) &quot;</span><span class="p">,</span> <span class="n">svals</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;svalues var&quot;</span><span class="p">,</span> <span class="n">s_values</span><span class="p">)</span>
        <span class="n">input_cnfs</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">in_imd</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;/coord&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;svals&quot;</span><span class="p">,</span> <span class="n">svals</span><span class="p">)</span>
            
        <span class="c1"># Put the proper cnfs in place        </span>
 
        <span class="k">if</span> <span class="p">(</span><span class="n">sub_control</span><span class="p">[</span><span class="s2">&quot;eoff_to_sopt&quot;</span><span class="p">]):</span>
            <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">optimized_eds_state_folder</span><span class="p">)):</span>
                <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s2">&quot;Could not find optimized state output dir: &quot;</span> <span class="o">+</span> <span class="n">optimized_eds_state_folder</span><span class="p">)</span>
            
            <span class="n">opt_state_cnfs</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">optimized_eds_state_folder</span><span class="o">+</span><span class="s1">&#39;/*.cnf&#39;</span><span class="p">),</span> 
                                    <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.cnf&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)))</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">svals</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">bash</span><span class="o">.</span><span class="n">copy_file</span><span class="p">(</span><span class="n">opt_state_cnfs</span><span class="p">[(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">%</span><span class="n">num_states</span><span class="p">],</span> <span class="n">next_dir</span> <span class="o">+</span> <span class="s1">&#39;/sopt_run_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.cnf&#39;</span><span class="p">)</span>

        <span class="k">elif</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">svals</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">svals</span><span class="p">[</span><span class="mi">1</span><span class="p">])))):</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;reduce coordinate Files:&quot;</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">optimized_eds_state_folder</span><span class="p">)):</span>
                <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s2">&quot;Could not find optimized state output dir: &quot;</span> <span class="o">+</span> <span class="n">optimized_eds_state_folder</span><span class="p">)</span>
            <span class="n">file_management</span><span class="o">.</span><span class="n">reduce_cnf_eoff</span><span class="p">(</span><span class="n">in_num_states</span><span class="o">=</span><span class="n">num_states</span><span class="p">,</span> <span class="n">in_opt_struct_cnf_dir</span><span class="o">=</span><span class="n">optimized_eds_state_folder</span><span class="p">,</span>
                                            <span class="n">in_current_sim_cnf_dir</span><span class="o">=</span><span class="n">input_cnfs</span><span class="p">,</span>
                                            <span class="n">in_old_svals</span><span class="o">=</span><span class="n">s_values</span><span class="p">,</span> <span class="n">in_new_svals</span><span class="o">=</span><span class="n">svals</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                            <span class="n">out_next_cnfs_dir</span><span class="o">=</span><span class="n">next_dir</span><span class="p">)</span>

        <span class="k">elif</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">svals</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">svals</span><span class="p">[</span><span class="mi">1</span><span class="p">])):</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;reduce coordinate Files:&quot;</span><span class="p">)</span>
            <span class="n">file_management</span><span class="o">.</span><span class="n">add_cnf_sopt_LRTOlike</span><span class="p">(</span><span class="n">in_dir</span><span class="o">=</span><span class="n">concat_file_folder</span><span class="p">,</span> <span class="n">out_dir</span><span class="o">=</span><span class="n">next_dir</span><span class="p">,</span> <span class="n">in_old_svals</span><span class="o">=</span><span class="n">s_values</span><span class="p">,</span>
                                                  <span class="n">cnf_prefix</span><span class="o">=</span><span class="n">title_prefix</span><span class="p">,</span>
                                                  <span class="n">in_new_svals</span><span class="o">=</span><span class="n">svals</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">replica_add_scheme</span><span class="o">=</span><span class="n">adding_new_sReplicas_Scheme</span><span class="p">,</span>
                                                  <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;same ammount of s_vals -&gt; simply copying output:&quot;</span><span class="p">)</span>
            <span class="n">bash</span><span class="o">.</span><span class="n">copy_file</span><span class="p">(</span><span class="n">concat_file_folder</span> <span class="o">+</span> <span class="s2">&quot;/*cnf&quot;</span><span class="p">,</span> <span class="n">next_dir</span><span class="p">)</span>

        <span class="c1"># write next_imd.</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;write out imd file &quot;</span><span class="p">)</span>
        <span class="n">imd_file</span> <span class="o">=</span> <span class="n">imd</span><span class="o">.</span><span class="n">Imd</span><span class="p">(</span><span class="n">in_imd</span><span class="p">)</span>

        <span class="c1">##New EnergyOffsets?</span>
        <span class="k">if</span> <span class="n">sub_control</span><span class="p">[</span><span class="s2">&quot;write_eoff&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">control_dict</span><span class="p">[</span><span class="s2">&quot;eoffset&quot;</span><span class="p">]:</span>
            <span class="n">imd_file</span><span class="o">.</span><span class="n">edit_REEDS</span><span class="p">(</span><span class="n">EIR</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">new_eoffs</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">sub_control</span><span class="p">[</span><span class="s2">&quot;write_eoff&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">control_dict</span><span class="p">[</span><span class="s2">&quot;Eoff&quot;</span><span class="p">][</span><span class="s2">&quot;sub&quot;</span><span class="p">][</span><span class="s2">&quot;calc_eoff&quot;</span><span class="p">]):</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Could not set Eoffs to imd, as not calculated in this run!&quot;</span><span class="p">)</span>

        <span class="c1">##New S-Values?=</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">sub_control</span><span class="p">[</span><span class="s2">&quot;write_s&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">control_dict</span><span class="p">[</span><span class="s2">&quot;sopt&quot;</span><span class="p">][</span><span class="s2">&quot;sub&quot;</span><span class="p">][</span><span class="s2">&quot;run_RTO&quot;</span><span class="p">])</span> <span class="ow">or</span> <span class="n">sub_control</span><span class="p">[</span><span class="s2">&quot;eoff_to_sopt&quot;</span><span class="p">]:</span>
            <span class="n">imd_file</span><span class="o">.</span><span class="n">edit_REEDS</span><span class="p">(</span><span class="n">SVALS</span><span class="o">=</span><span class="n">svals</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">sub_control</span><span class="p">[</span><span class="s2">&quot;write_s&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">control_dict</span><span class="p">[</span><span class="s2">&quot;sopt&quot;</span><span class="p">][</span><span class="s2">&quot;sub&quot;</span><span class="p">][</span><span class="s2">&quot;run_RTO&quot;</span><span class="p">]):</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Could not set s-values to imd, as not calculated in this run!&quot;</span><span class="p">)</span>

        <span class="n">imd_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">next_imd</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">verbose</span><span class="p">):</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Done</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">control_dict</span><span class="p">[</span><span class="s2">&quot;compress_simulation_folder&quot;</span><span class="p">][</span><span class="s2">&quot;do&quot;</span><span class="p">]):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Compress simulation folder&quot;</span><span class="p">)</span>
        <span class="n">in_tre</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">concat_file_folder</span> <span class="o">+</span> <span class="s2">&quot;/*.tre&quot;</span><span class="p">))</span>
        <span class="n">in_trc</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">concat_file_folder</span> <span class="o">+</span> <span class="s2">&quot;/*.trc&quot;</span><span class="p">))</span>
        <span class="n">compress_files</span> <span class="o">=</span> <span class="n">in_tre</span> <span class="o">+</span> <span class="n">in_trc</span>
        <span class="n">compress_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">in_folder</span><span class="p">]</span>

        <span class="n">file_management</span><span class="o">.</span><span class="n">compress_files</span><span class="p">(</span><span class="n">in_paths</span><span class="o">=</span><span class="n">compress_files</span><span class="p">)</span>
        <span class="n">file_management</span><span class="o">.</span><span class="n">compress_folder</span><span class="p">(</span><span class="n">in_paths</span><span class="o">=</span><span class="n">compress_list</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">verbose</span><span class="p">):</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Done</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">eoff_statistic</span><span class="p">,</span> <span class="n">svals</span><span class="p">,</span> <span class="n">dFs</span></div>
</pre></div>

           </div>
           
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2020, Benjamin Ries, Salome Rieder, Candide Champion. Project structure based on the Computational Molecular Science Python Cookiecutter version 1.3.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>